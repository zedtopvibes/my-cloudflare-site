<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zedtopvibes â€¢ Home</title>
    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/shared/main.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header will be injected by template-loader.js -->
    
    <!-- MAIN CONTENT CONTAINER -->
    <div class="main-content-container" id="content">
        <!-- Loading skeletons will be shown here -->
        <aside class="left-sidebar">
            <div class="section-header">
                <h2 class="section-title">LATEST RELEASES</h2>
                <a href="#" class="view-all">View All âž”</a>
            </div>
            
            <div class="post-list" id="tracksList">
                <!-- Loading skeletons -->
                <div class="skeleton-track">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                    </div>
                </div>
                <div class="skeleton-track">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                    </div>
                </div>
                <div class="skeleton-track">
                    <div class="skeleton-image"></div>
                    <div class="skeleton-content">
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                        <div class="skeleton-line long"></div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- RIGHT SIDEBAR -->
        <div class="right-sidebar">
            <!-- POPULAR GENRES SECTION -->
            <section class="section-block">
                <div class="section-header">
                    <h2 class="section-title">POPULAR GENRES</h2>
                    <a href="#" class="view-all">All</a>
                </div>
                <div style="padding: 15px 18px;" id="genresList">
                    <div class="skeleton" style="width: 80px; height: 30px; border-radius: 20px; display: inline-block; margin: 2px;"></div>
                    <div class="skeleton" style="width: 70px; height: 30px; border-radius: 20px; display: inline-block; margin: 2px;"></div>
                    <div class="skeleton" style="width: 90px; height: 30px; border-radius: 20px; display: inline-block; margin: 2px;"></div>
                </div>
            </section>
            
            <!-- TRENDING SECTION -->
            <section class="section-block">
                <div class="section-header">
                    <h2 class="section-title">TRENDING ðŸ”¥</h2>
                    <a href="#" class="view-all">More</a>
                </div>
                <div id="trendingList">
                    <div class="skeleton" style="height: 60px; margin: 10px;"></div>
                    <div class="skeleton" style="height: 60px; margin: 10px;"></div>
                    <div class="skeleton" style="height: 60px; margin: 10px;"></div>
                </div>
            </section>
            
            <!-- FEATURED ARTISTS SECTION -->
            <section class="section-block">
                <div class="section-header">
                    <h2 class="section-title">FEATURED ARTISTS</h2>
                    <a href="#" class="view-all">View All</a>
                </div>
                <div id="artistsList">
                    <div class="skeleton" style="height: 70px; margin: 10px;"></div>
                    <div class="skeleton" style="height: 70px; margin: 10px;"></div>
                    <div class="skeleton" style="height: 70px; margin: 10px;"></div>
                </div>
            </section>
        </div>
    </div>

    <!-- Footer will be injected by template-loader.js -->

    <script type="module">
        import { injectTemplates, loadTemplate } from '/js/shared/template-loader.js';
        import { API_BASE, formatNumber, formatDate, getEmojiForGenre, getRandomColor } from '/js/shared/helpers.js';
        import { goHome, goToArtist, goToSong } from '/js/shared/navigation.js';

        // ===== DATA LOADING FUNCTIONS =====
        async function loadTracks() {
            try {
                const response = await fetch(`${API_BASE}/tracks`);
                const tracks = await response.json();
                
                // Sort by uploaded_at (newest first)
                tracks.sort((a, b) => new Date(b.uploaded_at) - new Date(a.uploaded_at));
                
                const tracksList = document.getElementById('tracksList');
                tracksList.innerHTML = tracks.slice(0, 6).map(track => `
                    <div class="track-item" onclick="goToSong(${track.id}, '${track.slug}')">
                        <div class="track-number">#</div>
                        <div class="track-info">
                            <div class="track-title">${track.title}</div>
                            <div class="track-artist" onclick="event.stopPropagation(); goToArtist('${track.artist.replace(/'/g, "\\'")}')">${track.artist}</div>
                            <div class="track-meta">
                                <span class="track-plays"><i class="fas fa-headphones"></i> ${formatNumber(track.plays)}</span>
                                <span class="track-views"><i class="fas fa-eye"></i> ${formatNumber(track.views)}</span>
                                <span class="track-date">${formatDate(track.uploaded_at)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading tracks:', error);
                document.getElementById('tracksList').innerHTML = '<div style="padding: 20px; text-align: center;">Error loading tracks</div>';
            }
        }

        async function loadTrending() {
            try {
                const response = await fetch(`${API_BASE}/trending`);
                const trending = await response.json();
                
                const trendingList = document.getElementById('trendingList');
                trendingList.innerHTML = trending.slice(0, 3).map((track, index) => `
                    <div class="trending-item" onclick="goToSong(${track.id}, '${track.slug}')">
                        <span class="trending-number">${String(index + 1).padStart(2, '0')}</span>
                        <div class="trending-info">
                            <h4>${track.title}</h4>
                            <p onclick="event.stopPropagation(); goToArtist('${track.artist.replace(/'/g, "\\'")}')">${track.artist}</p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading trending:', error);
            }
        }

        async function loadGenres() {
            try {
                const response = await fetch(`${API_BASE}/tracks`);
                const tracks = await response.json();
                
                // Get unique genres
                const genres = [...new Set(tracks.map(t => t.genre))];
                
                const genresList = document.getElementById('genresList');
                genresList.innerHTML = genres.map(genre => `
                    <span class="genre-tag" onclick="filterByGenre('${genre}')">#${genre}</span>
                `).join('');
            } catch (error) {
                console.error('Error loading genres:', error);
            }
        }

        async function loadArtists() {
            try {
                const response = await fetch(`${API_BASE}/tracks`);
                const tracks = await response.json();
                
                // Group by artist
                const artistMap = new Map();
                tracks.forEach(track => {
                    if (!artistMap.has(track.artist)) {
                        artistMap.set(track.artist, {
                            name: track.artist,
                            slug: track.artist_slug,
                            trackCount: 1
                        });
                    } else {
                        const artist = artistMap.get(track.artist);
                        artist.trackCount++;
                    }
                });
                
                const artists = Array.from(artistMap.values())
                    .sort((a, b) => b.trackCount - a.trackCount)
                    .slice(0, 3);
                
                const artistsList = document.getElementById('artistsList');
                artistsList.innerHTML = artists.map(artist => `
                    <div class="artist-item" onclick="goToArtist('${artist.name}')">
                        <div class="artist-avatar" style="background: ${getRandomColor()}">ðŸ‘¤</div>
                        <div class="artist-info">
                            <h4 class="artist-name">${artist.name}</h4>
                            <p class="artist-meta">${artist.trackCount} tracks</p>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading artists:', error);
            }
        }

        function filterByGenre(genre) {
            alert(`Filtering by genre: ${genre} (coming soon!)`);
        }

        // Initialize page
        async function initPage() {
            // Inject header and footer templates
            await injectTemplates();
            const footerHtml = await loadTemplate('footer');
            document.body.insertAdjacentHTML('beforeend', footerHtml);
            
            // Make goHome available globally for hamburger menu
            window.goHome = goHome;
            
            // Update hamburger menu to use goHome
            const hamburger = document.querySelector('.hamburger');
            if (hamburger) {
                hamburger.onclick = goHome;
            }
            
            // Load all data
            await Promise.all([
                loadTracks(),
                loadTrending(),
                loadGenres(),
                loadArtists()
            ]);
        }

        // Make navigation functions globally available
        window.goToArtist = goToArtist;
        window.goToSong = goToSong;
        window.filterByGenre = filterByGenre;

        // Start everything
        initPage();
    </script>
</body>
</html>