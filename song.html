<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Song | Zedtopvibes</title>
<link rel="stylesheet" href="/css/shared/main.css">
</head>
<body>
    <div class="main-content-container" id="content">
        <div style="text-align: center; padding: 60px; width: 100%;">Loading song...</div>
    </div>

    <div id="nowPlayingBar" class="now-playing-bar" style="display: none;">
        <div class="now-playing-info">
            <div id="nowPlayingTitle" class="now-playing-title">Not playing</div>
            <div id="nowPlayingArtist" class="now-playing-artist"></div>
        </div>
        <div class="now-playing-controls">
            <button class="now-playing-btn" onclick="togglePlay()" id="playPauseBtn">▶️</button>
            <button class="now-playing-btn" onclick="closePlayer()">✕</button>
        </div>
    </div>

    <script type="module">
        import { API_BASE, formatNumber, formatDuration, getEmojiForGenre } from '/js/shared/helpers.js';
        import { goToArtist, goToSong } from '/js/shared/navigation.js';
        import { fetchSong, incrementPlays } from '/js/shared/api.js';
        import { injectTemplates, loadTemplate } from '/js/shared/template-loader.js';

        // Get song identifier
        const urlParams = new URLSearchParams(window.location.search);
        const songId = urlParams.get('id');
        const contentDiv = document.getElementById('content');
        const songSlug = contentDiv?.dataset.songSlug;

        let songIdentifier = songSlug || songId;
        let useSlug = !!songSlug;
        
        // Audio player
        let audioPlayer = null;
        let currentTrack = null;
        let isPlaying = false;

        // Load song data
        async function loadSong() {
            if (!songIdentifier) {
                document.getElementById('content').innerHTML = '<div style="text-align: center; padding: 60px;">No track specified</div>';
                return;
            }

            try {
                const skeleton = await loadTemplate('loading-skeleton');
                document.getElementById('content').innerHTML = skeleton;

                const apiUrl = useSlug 
                    ? `${API_BASE}/song/by-slug/${songIdentifier}`
                    : `${API_BASE}/tracks/${songIdentifier}`;

                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Track not found');
                
                const track = await response.json();
                
                // Increment view count
                fetch(`${API_BASE}/tracks/${track.id}/view`, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).catch(err => console.error('View count error:', err));
                
                currentTrack = track;
                renderSong(track);

            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <p style="color: #ff5500;">Error: ${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #ff5500; color: white; border: none; border-radius: 20px; cursor: pointer;">Try Again</button>
                    </div>
                `;
            }
        }

        // Render song page
        function renderSong(track) {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <aside class="left-sidebar">
                    <div class="breadcrumbs">
                        <a href="/">Home</a> / 
                        <a href="#" onclick="goToArtist('${track.artist.replace(/'/g, "\\'")}')">${track.artist}</a> / 
                        <span>${track.title}</span>
                    </div>
                    
                    <div class="song-header">
                        <div class="song-cover">${getEmojiForGenre(track.genre)}</div>
                        <div class="song-info">
                            <h1 class="song-title">${track.title}</h1>
                            <div class="song-artist" onclick="goToArtist('${track.artist.replace(/'/g, "\\'")}')">${track.artist}</div>
                            <div class="song-meta">
                                <span class="song-stats"><i class="fas fa-clock"></i> ${formatDuration(track.duration)}</span>
                                <span class="song-stats"><i class="fas fa-calendar"></i> ${new Date(track.uploaded_at).getFullYear()}</span>
                                <span class="song-stats"><i class="fas fa-headphones"></i> ${formatNumber(track.plays)}</span>
                                <span class="song-stats"><i class="fas fa-download"></i> ${formatNumber(track.downloads)}</span>
                                <span class="song-stats"><i class="fas fa-eye"></i> ${formatNumber(track.views)}</span>
                            </div>
                            <p class="song-description">${track.description || 'No description available.'}</p>
                        </div>
                    </div>
                    
                    <div class="compact-actions">
                        <div class="player-controls">
                            <button class="control-btn" onclick="playPrevious()">⏮</button>
                            <button class="control-btn play-btn" onclick="playCurrentTrack()">▶</button>
                            <button class="control-btn" onclick="playNext()">⏭</button>
                        </div>
                        <div class="action-buttons">
                            <button class="action-btn" onclick="likeTrack(${track.id})">❤️ Like</button>
                            <button class="action-btn" onclick="addToPlaylist(${track.id})">➕ Playlist</button>
                            <button class="action-btn download-btn" onclick="downloadTrack('${track.r2_key}')">⬇️ Download</button>
                        </div>
                    </div>
                </aside>
                
                <div class="right-sidebar">
                    <section class="section-block">
                        <div class="section-header">
                            <h2 class="section-title">More by ${track.artist}</h2>
                            <a href="#" onclick="goToArtist('${track.artist.replace(/'/g, "\\'")}')" class="view-all">View All ➔</a>
                        </div>
                        <div id="moreByArtist" class="latest-albums-list">Loading...</div>
                    </section>
                </div>
            `;

            // Load more by artist
            loadMoreByArtist(track.artist, track.id);
        }

        // Load more tracks by same artist
        async function loadMoreByArtist(artist, currentTrackId) {
            try {
                const response = await fetch(`${API_BASE}/tracks`);
                const tracks = await response.json();
                
                const moreTracks = tracks
                    .filter(t => t.artist === artist && t.id != currentTrackId)
                    .slice(0, 3);
                
                const container = document.getElementById('moreByArtist');
                if (container) {
                    if (moreTracks.length > 0) {
                        container.innerHTML = moreTracks.map(track => `
                            <div class="sidebar-item" onclick="goToSong(${track.id}, '${track.slug}')">
                                <div class="sidebar-thumb">${getEmojiForGenre(track.genre)}</div>
                                <div class="sidebar-info">
                                    <div class="sidebar-title">${track.title}</div>
                                    <div class="sidebar-sub"><i class="fas fa-headphones"></i> ${formatNumber(track.plays)}</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div style="padding: 15px; text-align: center;">No other tracks</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading more by artist:', error);
            }
        }

        // Audio functions
        function playCurrentTrack() {
            if (!currentTrack) return;
            playTrack(currentTrack);
        }

        async function playTrack(track) {
            try {
                await incrementPlays('track', track.id);
                
                const audioUrl = `${API_BASE}/stream/${encodeURIComponent(track.r2_key)}`;
                
                if (audioPlayer) audioPlayer.pause();
                
                audioPlayer = new Audio(audioUrl);
                await audioPlayer.play();
                isPlaying = true;
                
                document.getElementById('nowPlayingTitle').textContent = track.title;
                document.getElementById('nowPlayingArtist').textContent = track.artist;
                document.getElementById('nowPlayingArtist').onclick = () => goToArtist(track.artist);
                document.getElementById('playPauseBtn').textContent = '⏸️';
                document.getElementById('nowPlayingBar').style.display = 'flex';
                
                audioPlayer.onended = () => {
                    isPlaying = false;
                    document.getElementById('playPauseBtn').textContent = '▶️';
                };
            } catch (error) {
                console.error('Playback error:', error);
            }
        }

        function togglePlay() {
            if (!audioPlayer) return;
            if (isPlaying) {
                audioPlayer.pause();
                document.getElementById('playPauseBtn').textContent = '▶️';
            } else {
                audioPlayer.play();
                document.getElementById('playPauseBtn').textContent = '⏸️';
            }
            isPlaying = !isPlaying;
        }

        function closePlayer() {
            if (audioPlayer) {
                audioPlayer.pause();
                audioPlayer = null;
            }
            document.getElementById('nowPlayingBar').style.display = 'none';
            isPlaying = false;
        }

        function downloadTrack(r2Key) {
            const audioUrl = `${API_BASE}/stream/${encodeURIComponent(r2Key)}`;
            window.open(audioUrl, '_blank');
        }

        function playPrevious() { alert('Previous track'); }
        function playNext() { alert('Next track'); }
        function likeTrack(id) { alert('Like feature coming soon!'); }
        function addToPlaylist(id) { alert('Playlists coming soon!'); }

        // Initialize page
        async function initPage() {
            await injectTemplates();
            const footerHtml = await loadTemplate('footer');
            document.body.insertAdjacentHTML('beforeend', footerHtml);
            await loadSong();
        }

        initPage();
        
        // Make functions global
        window.goToArtist = goToArtist;
        window.goToSong = goToSong;
        window.togglePlay = togglePlay;
        window.closePlayer = closePlayer;
        window.playCurrentTrack = playCurrentTrack;
        window.playPrevious = playPrevious;
        window.playNext = playNext;
        window.likeTrack = likeTrack;
        window.addToPlaylist = addToPlaylist;
        window.downloadTrack = downloadTrack;
    </script>
</body>
</html>