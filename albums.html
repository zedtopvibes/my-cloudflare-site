<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zedtopvibes â€¢ Albums</title>
    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/shared/main.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header will be injected by JavaScript -->
    
    <!-- MAIN CONTENT CONTAINER -->
    <div class="main-content-container" id="content">
        <!-- Content will be populated by JavaScript -->
    </div>

    <!-- Footer will be injected by JavaScript -->

    <script type="module">
        import { injectTemplates, loadTemplate } from '/js/shared/template-loader.js';
        import { API_BASE, formatNumber } from '/js/shared/helpers.js';
        import { goHome, goToArtist, goToAlbumBySlug } from '/js/shared/navigation.js';

        // Initialize page with templates
        async function initPage() {
            try {
                // Inject header and get footer HTML
                await injectTemplates();
                
                // Load and inject footer separately
                const footerHtml = await loadTemplate('footer');
                document.body.insertAdjacentHTML('beforeend', footerHtml);
                
                // Make goHome available for hamburger
                window.goHome = goHome;
                
                // Update hamburger menu
                const hamburger = document.querySelector('.hamburger');
                if (hamburger) {
                    hamburger.onclick = goHome;
                }

                // Now load the albums data
                await loadAlbums();

            } catch (error) {
                console.error('Error initializing page:', error);
                document.getElementById('content').innerHTML = '<div style="text-align: center; padding: 60px;">Error loading page</div>';
            }
        }

        // Load albums data
        async function loadAlbums() {
            const contentDiv = document.getElementById('content');
            
            // Show loading state
            contentDiv.innerHTML = `
                <aside class="left-sidebar">
                    <div class="breadcrumbs">
                        <span class="skeleton" style="display: inline-block; width: 200px; height: 20px;"></span>
                    </div>
                    
                    <div class="section-header">
                        <h2 class="section-title">All Albums</h2>
                        <a href="#" class="view-all">View All âž”</a>
                    </div>
                    
                    <div class="album-list" id="albumsList">
                        <div class="skeleton-track">
                            <div class="skeleton-image" style="width: 100px; height: 100px;"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-line short"></div>
                                <div class="skeleton-line medium"></div>
                                <div class="skeleton-line long"></div>
                            </div>
                        </div>
                        <div class="skeleton-track">
                            <div class="skeleton-image" style="width: 100px; height: 100px;"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-line short"></div>
                                <div class="skeleton-line medium"></div>
                                <div class="skeleton-line long"></div>
                            </div>
                        </div>
                    </div>
                </aside>
                
                <div class="right-sidebar">
                    <section class="section-block">
                        <div class="section-header">
                            <h2 class="section-title">Featured Albums</h2>
                            <a href="#" class="view-all">View All âž”</a>
                        </div>
                        <div id="featuredAlbums" class="latest-albums-list">
                            <div class="skeleton" style="height: 70px; margin: 10px;"></div>
                        </div>
                    </section>
                    
                    <section class="section-block">
                        <div class="section-header">
                            <h2 class="section-title">Top Artists</h2>
                            <a href="#" class="view-all">View All âž”</a>
                        </div>
                        <div id="topArtists" class="latest-albums-list">
                            <div class="skeleton" style="height: 70px; margin: 10px;"></div>
                        </div>
                    </section>
                </div>
            `;

            try {
                // Fetch albums from API
                const response = await fetch(`${API_BASE}/albums`);
                const albums = await response.json();
                
                // Render the content
                renderAlbums(albums);
                renderFeaturedAlbums(albums);
                renderTopArtists(albums);

            } catch (error) {
                console.error('Error loading albums:', error);
                document.getElementById('albumsList').innerHTML = '<div style="padding: 20px; text-align: center; color: #ff5500;">Error loading albums</div>';
            }
        }

        // Render main albums list
        function renderAlbums(albums) {
            const container = document.getElementById('albumsList');
            if (!container) return;
            
            if (albums.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center;">No albums found</div>';
                return;
            }
            
            container.innerHTML = albums.map(album => `
                <div class="album-item" onclick="goToAlbumBySlug('${album.slug}')">
                    <div class="album-thumb">${album.cover_emoji || 'ðŸ’¿'}</div>
                    <div class="album-info">
                        <div class="album-title">${album.title || 'Untitled'}</div>
                        <div class="album-meta">
                            <span class="album-artist" onclick="event.stopPropagation(); goToArtist('${album.artist?.replace(/'/g, "\\'") || ''}')">${album.artist || 'Unknown Artist'}</span>
                            <span class="album-tracks">${album.track_count || 0} tracks</span>
                            <span class="album-stats"><i class="fas fa-eye"></i> ${formatNumber(album.views)}</span>
                        </div>
                        <div class="album-year">ðŸ“… ${album.release_date ? new Date(album.release_date).getFullYear() : 'Unknown'}</div>
                    </div>
                </div>
            `).join('');
        }

        // Render featured albums
        function renderFeaturedAlbums(albums) {
            const container = document.getElementById('featuredAlbums');
            if (!container) return;
            
            const featured = albums.filter(a => a.is_featured).slice(0, 3);
            
            if (featured.length > 0) {
                container.innerHTML = featured.map(album => `
                    <div class="sidebar-item" onclick="goToAlbumBySlug('${album.slug}')">
                        <div class="sidebar-thumb">${album.cover_emoji || 'ðŸ’¿'}</div>
                        <div class="sidebar-info">
                            <div class="sidebar-title">${album.title}</div>
                            <div class="sidebar-sub">${album.artist}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div style="padding: 15px; text-align: center;">No featured albums</div>';
            }
        }

        // Render top artists
        function renderTopArtists(albums) {
            const container = document.getElementById('topArtists');
            if (!container) return;
            
            // Get unique artists
            const artistMap = new Map();
            albums.forEach(album => {
                if (album.artist && !artistMap.has(album.artist)) {
                    artistMap.set(album.artist, {
                        name: album.artist,
                        count: 1
                    });
                } else if (album.artist) {
                    const artist = artistMap.get(album.artist);
                    artist.count++;
                }
            });
            
            const artists = Array.from(artistMap.values())
                .sort((a, b) => b.count - a.count)
                .slice(0, 3);
            
            if (artists.length > 0) {
                container.innerHTML = artists.map(artist => `
                    <div class="sidebar-item" onclick="goToArtist('${artist.name.replace(/'/g, "\\'")}')">
                        <div class="sidebar-thumb">ðŸ‘¤</div>
                        <div class="sidebar-info">
                            <div class="sidebar-title">${artist.name}</div>
                            <div class="sidebar-sub">${artist.count} albums</div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div style="padding: 15px; text-align: center;">No artists found</div>';
            }
        }

        // Start everything
        initPage();

        // Make navigation functions global
        window.goToArtist = goToArtist;
        window.goToAlbumBySlug = goToAlbumBySlug;
    </script>
</body>
</html>