<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zedtopvibes â€¢ Playlist</title>
    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/shared/main.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Simple header -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="hamburger" onclick="window.location.href='/'">â˜°</div>
            <div class="site-title"><a href="/">ZEDTOPVIBES</a></div>
            <div class="right-spacer"></div>
        </div>
    </nav>

    <!-- MAIN CONTENT CONTAINER -->
    <div class="main-content-container" id="content">
        <div style="text-align: center; padding: 60px;">Loading playlist...</div>
    </div>

    <!-- Simple footer -->
    <footer class="footer">
        <div class="footer-links">
            <a href="/">Home</a>
            <a href="/albums.html">Albums</a>
            <a href="/playlists.html">Playlists</a>
            <a href="/artists.html">Artists</a>
        </div>
        <div class="copyright">Â© 2024 Zedtopvibes</div>
    </footer>

    <script type="module">
        // Try to import shared helpers, with fallback
        let formatNumber = (num) => num;
        let formatDuration = (seconds) => {
            if (!seconds) return '?:??';
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        };
        
        try {
            const helpers = await import('/js/shared/helpers.js');
            formatNumber = helpers.formatNumber;
            formatDuration = helpers.formatDuration;
        } catch (e) {
            console.log('Using fallback formatters');
        }

        // API Base
        const API_BASE = '/api';
        
        // Get playlist slug from URL
        const pathParts = window.location.pathname.split('/');
        const playlistSlug = pathParts[pathParts.length - 1];
        
        // Also check for ?id= parameter
        const urlParams = new URLSearchParams(window.location.search);
        const playlistId = urlParams.get('id');

        // Navigation functions
        window.goHome = () => window.location.href = '/';
        window.goToArtist = (name) => {
            const slug = name.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
            window.location.href = `/artist/${slug}`;
        };
        window.goToSong = (id, slug) => {
            if (slug) window.location.href = `/song/${slug}`;
            else window.location.href = `/song.html?id=${id}`;
        };
        window.goToPlaylist = (slug) => window.location.href = `/playlist/${slug}`;

        // Load playlist data
        async function loadPlaylist() {
            try {
                // Determine API URL
                let apiUrl;
                if (playlistSlug && playlistSlug !== 'playlist.html') {
                    apiUrl = `${API_BASE}/playlist/by-slug/${playlistSlug}`;
                } else if (playlistId) {
                    apiUrl = `${API_BASE}/playlists/${playlistId}`;
                } else {
                    document.getElementById('content').innerHTML = '<div style="text-align: center; padding: 60px;">No playlist specified</div>';
                    return;
                }

                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Playlist not found');
                
                const playlist = await response.json();
                
                // Increment view count
                fetch(`${API_BASE}/playlists/${playlist.id}/view`, { method: 'POST' }).catch(() => {});
                
                renderPlaylist(playlist);

            } catch (error) {
                document.getElementById('content').innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <p style="color: #ff5500;">Error: ${error.message}</p>
                        <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #ff5500; color: white; border: none; border-radius: 20px; cursor: pointer;">Try Again</button>
                    </div>
                `;
            }
        }

        // Calculate total duration
        function calculateTotalDuration(tracks) {
            if (!tracks || tracks.length === 0) return '0 min';
            const totalSeconds = tracks.reduce((sum, track) => sum + (track.duration || 0), 0);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            return hours > 0 ? `${hours} hr ${minutes} min` : `${minutes} min`;
        }

        // Render playlist page
        function renderPlaylist(playlist) {
            const tracks = playlist.tracks || [];
            const totalDuration = calculateTotalDuration(tracks);
            const totalPlays = tracks.reduce((sum, t) => sum + (t.plays || 0), 0);
            const totalDownloads = tracks.reduce((sum, t) => sum + (t.downloads || 0), 0);
            const createdDate = playlist.created_at ? new Date(playlist.created_at).toLocaleDateString() : 'Unknown';

            // Get unique artists
            const artists = [...new Set(tracks.map(t => t.artist).filter(a => a))].slice(0, 3);

            const content = document.getElementById('content');
            
            content.innerHTML = `
                <aside class="left-sidebar">
                    <!-- Breadcrumbs -->
                    <div class="breadcrumbs">
                        <a href="/">Home</a> / 
                        <a href="/playlists.html">Playlists</a> / 
                        <span>${playlist.name}</span>
                    </div>
                    
                    <!-- Playlist Header -->
                    <div class="playlist-header">
                        <div class="playlist-cover">${playlist.cover_emoji || 'ðŸ“‹'}</div>
                        <div class="playlist-info">
                            <h1 class="playlist-title">${playlist.name}</h1>
                            <div class="playlist-meta">
                                <span class="playlist-stats"><i class="fas fa-music"></i> ${tracks.length} tracks</span>
                                <span class="playlist-stats"><i class="fas fa-clock"></i> ${totalDuration}</span>
                                <span class="playlist-stats"><i class="fas fa-headphones"></i> ${formatNumber(playlist.plays || totalPlays)}</span>
                                <span class="playlist-stats"><i class="fas fa-download"></i> ${formatNumber(playlist.downloads || totalDownloads)}</span>
                                <span class="playlist-stats"><i class="fas fa-eye"></i> ${formatNumber(playlist.views || 0)}</span>
                            </div>
                            <p class="playlist-description">${playlist.description || 'No description available.'}</p>
                            <div class="playlist-created">Created by ${playlist.created_by || 'Zedtopvibes'} â€¢ ${createdDate}</div>
                        </div>
                    </div>
                    
                    <!-- Tracks Section -->
                    <div class="section-header">
                        <h2 class="section-title">Playlist Tracks</h2>
                        <a href="#" class="view-all">View All âž”</a>
                    </div>
                    
                    <div class="track-list">
                        ${tracks.length > 0 ? tracks.map((track, index) => `
                            <div class="track-item" onclick="goToSong(${track.id}, '${track.slug || ''}')">
                                <div class="track-number">${String(index + 1).padStart(2, '0')}</div>
                                <div class="track-info">
                                    <div class="track-title">${track.title}</div>
                                    <div class="track-artist" onclick="event.stopPropagation(); goToArtist('${track.artist?.replace(/'/g, "\\'") || ''}')">${track.artist}</div>
                                </div>
                                <div class="track-meta">
                                    <span class="track-duration"><i class="fas fa-clock"></i> ${formatDuration(track.duration)}</span>
                                    <span class="track-plays"><i class="fas fa-headphones"></i> ${formatNumber(track.plays)}</span>
                                    <span class="track-downloads"><i class="fas fa-download"></i> ${formatNumber(track.downloads)}</span>
                                </div>
                            </div>
                        `).join('') : '<div style="padding: 20px; text-align: center;">No tracks in this playlist</div>'}
                    </div>
                </aside>
                
                <!-- RIGHT SIDEBAR -->
                <div class="right-sidebar">
                    <!-- Similar Playlists -->
                    <section class="section-block">
                        <div class="section-header">
                            <h2 class="section-title">Similar Playlists</h2>
                            <a href="/playlists.html" class="view-all">View All âž”</a>
                        </div>
                        <div id="similarPlaylists" class="latest-albums-list">
                            <div class="loading">Loading...</div>
                        </div>
                    </section>
                    
                    <!-- Featured Artists -->
                    <section class="section-block">
                        <div class="section-header">
                            <h2 class="section-title">Featured Artists</h2>
                        </div>
                        <div class="latest-albums-list">
                            ${artists.length > 0 ? artists.map(artist => `
                                <div class="sidebar-item" onclick="goToArtist('${artist.replace(/'/g, "\\'")}')">
                                    <div class="sidebar-thumb">ðŸ‘¤</div>
                                    <div class="sidebar-info">
                                        <div class="sidebar-title">${artist}</div>
                                        <div class="sidebar-sub">Featured in playlist</div>
                                    </div>
                                </div>
                            `).join('') : '<div style="padding: 15px; text-align: center;">No artists</div>'}
                        </div>
                    </section>
                    
                    <!-- Playlist Info -->
                    <section class="section-block">
                        <div class="section-header">
                            <h2 class="section-title">Playlist Info</h2>
                        </div>
                        <div>
                            <div class="info-row"><span class="info-label">Created</span><span class="info-value">${createdDate}</span></div>
                            <div class="info-row"><span class="info-label">By</span><span class="info-value">${playlist.created_by || 'Zedtopvibes'}</span></div>
                            <div class="info-row"><span class="info-label">Tracks</span><span class="info-value">${tracks.length}</span></div>
                            <div class="info-row"><span class="info-label">Duration</span><span class="info-value">${totalDuration}</span></div>
                        </div>
                    </section>
                </div>
            `;

            // Load similar playlists
            loadSimilarPlaylists(playlist.id);
        }

        // Load similar playlists
        async function loadSimilarPlaylists(currentPlaylistId) {
            try {
                const response = await fetch(`${API_BASE}/playlists`);
                const playlists = await response.json();
                
                const similar = playlists.filter(p => p.id != currentPlaylistId).slice(0, 3);
                
                const container = document.getElementById('similarPlaylists');
                if (container) {
                    if (similar.length > 0) {
                        container.innerHTML = similar.map(playlist => `
                            <div class="sidebar-item" onclick="goToPlaylist('${playlist.slug}')">
                                <div class="sidebar-thumb">${playlist.cover_emoji || 'ðŸ“‹'}</div>
                                <div class="sidebar-info">
                                    <div class="sidebar-title">${playlist.name}</div>
                                    <div class="sidebar-sub">${playlist.track_count || 0} tracks</div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<div style="padding: 15px; text-align: center;">No similar playlists</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading similar playlists:', error);
            }
        }

        // Load the playlist
        loadPlaylist();
    </script>
</body>
</html>